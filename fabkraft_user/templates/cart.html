{% extends 'base/base.html' %} {%load static%} {% block title %} Buy2Sell {% endblock %} {% block content %}
    <div class="container" style="padding-left: 10px;">


<style>
/* Hide the scrollbar */

#cart-container {
    overflow-x: auto;
    /* Hide scrollbar for IE, Edge and Firefox */
    scrollbar-width: none;
    /* Hide scrollbar for Chrome, Safari and Opera */
    -ms-overflow-style: none;
}

/* Hide scrollbar for Chrome, Safari and Opera */
#cart-container::-webkit-scrollbar {
    display: none;
}

/* Add custom scrollbar design */
#cart-container::-webkit-scrollbar-track {
    background-color: #f1f1f1; /* Change this to your desired color */
}

#cart-container::-webkit-scrollbar-thumb {
    background-color: #888; /* Change this to your desired color */
}


#cart-container table{
    border-collapse: collapse;
    width: 100%;
    table-layout: fixed;
    white-space: nowrap;
    margin: 60px auto;
}
#cart-container table thead{
    font-weight: 700;
}
#cart-container table thead td{
background: #c8a59a;
color:#ffff;
border: none;
padding: 6px 0;
}

#cart-container table td{
border: 1px solid #dddddd;
text-align: center;
}

#cart-container table td:nth-child(1){
    width: 100px;
}

#cart-container table td:nth-child(2),
#cart-container table td:nth-child(3){
    width: 200px;
}
#cart-container table td:nth-child(4),
#cart-container table td:nth-child(5),
#cart-container table td:nth-child(6){
width: 170px;
}

#cart-container table tbody img{
    width: 100px;
    height: 80px;
    object-fit: cover;
}

#cart-bottom .total>div {
border: 1px solid #dddddd;
}

#cart-bottom .total h5{
background: #c8a59a;
color:#ffff;
border: none;
padding: 15px 19px;
font-weight: 700;
}
#cart-bottom .total div>div{
    padding: 0 12px;
}

#cart-bottom .total p{
    color: #000000;
    font-weight:400;
}
.second-hr{
    background-color: #b8b7b3;
    width: 100%;
    height: 1px;
}

#cart-bottom .total div>button{
    margin: 0 12px 20px 0;
    display: flex;
    justify-content: flex-end;
}
 /* Add ellipsis to long product names */
 .product-name {
        max-width: 200px; /* Adjust this value according to your table layout */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    @media only screen and (max-width: 767px) {
    #cart-container .card {
        width: 100%;
    }
    #cart-container .card-body {
        text-align: center;
    }
    #cart-container .card-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #cart-container .quantity {
        margin-top: 10px;
    }
    .container {
            margin: 0; /* Remove default margin for container */
        }
}
.message-box {
    padding: 20px;
    margin: 20px;
    color: white;
    border-radius: 5px;
    font-family: Arial, sans-serif;
}

.green {
    background-color: green;
}

.red {
    background-color: red;
}

</style>



<form action="{% url 'checkout_cart' %}" method="post" id="checkout-form">
    {% csrf_token %}
    <section id="cart-container" class="container my-5">
        <div class="row">
            {% if not cart %}
            <div class="message-box red"><center>Nothing in CART!!</center></div>
            {% endif %}
            {% for i in cart %}
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-body">
                        <img src="/media/{{ i.products.images_set.first.images }}" class="card-img-top" style="width: 8em;height: 9em;" alt="">
                        <h5 class="card-title">{{ i.products.product_name }}</h5>

                        {% if i.products.product_choices_set.all %}
                        <select id="verients-{{ i.id }}" name="verients" class="verients" data-product-id="{{ i.id }}">
                            {% for verient in i.products.product_choices_set.all %}
                            <option value="{{ verient.id }}" data-cost="{{ verient.options_cost }}" {% if verient.id == i.verients.id %} selected {% endif %}>{{ verient.product_options }}</option>
                            {% endfor %}
                        </select>
                        <p class="card-text price" id="price-{{ i.id }}" data-price="{{ i.verients.options_cost }}">Price: {{ i.verients.options_cost }}</p>
                        {% else %}
                        <p class="card-text price" id="price-{{ i.id }}" data-price="{{ i.products.price }}">Price: {{ i.products.price }}</p>
                        {% endif %}

                        <label for="quantity-{{ i.id }}">Quantity:</label>
                        <input type="number" id="quantity-{{ i.id }}" class="form-control quantity" name="quantity" min="1" value="{{ i.quantity }}" data-product-id="{{ i.id }}">

                        <button type="button" class="add-btn" onclick="updateCart('{{i.id}}','{{ i.products.id }}')"><i class="fa fa-add"></i>Update</button>

                        <a href="{% url 'remove_from_cart' i.id %}" class="remove-btn"><i class="fa fa-trash"></i> Remove</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
</form>

<section id="cart-bottom">
    <div class="row">
        <div class="total col-lg-6 col-md-10 col-12">
            <div>
                <h5>CART TOTAL</h5>
                <div class="d-flex justify-content-between">
                    <p>Subtotal</p>
                    <p id="subtotal">00</p>
                </div>
                <hr class="second-hr">
                <div class="d-flex justify-content-between">
                    <p>TOTAL</p>
                    <p id="total">00</p>
                </div>
                <button class="m1-auto" onclick="proceedToCheckout()">PROCEED TO CHECKOUT</button>
            </div>
        </div>
    </div>
</section>


    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script>
            function updateCart(itemId,prodId) {
                console.log("prod",prodId);
                console.log('cart',itemId)
                const quantity = document.getElementById('quantity-' + itemId).value;

                console.log('quantity',quantity)

                // Check if the element exists before accessing its value
                const verientElement = document.getElementById('verients-' + itemId);
                let verientId = null;

                if (verientElement) {
                    verientId = verientElement.value;
                }

                fetch(`/update_cart/${prodId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        quantity: quantity,
                        verientId: verientId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Cart item updated successfully:', data);
                    // Optionally update UI here
                    if (data.flag == 'merged'){
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error updating cart item:', error);
                    // Handle error (if needed)
                });
            }

            function proceedToCheckout() {
                // Submit the main checkout form
                const checkoutForm = document.getElementById('checkout-form');
                if (checkoutForm) {
                    checkoutForm.submit();
                } else {
                    console.error('Checkout form not found');
                }
            }
        </script>

<script>
$(document).ready(function() {
    function updatePriceAndTotal() {
        var subtotal = 0;

        // Loop through each product card
        $('.card').each(function() {
            var $card = $(this);
            var productID = $card.find('.verients').data('product-id');
            var $variantSelect = $card.find('.verients');
            var selectedVariant = $variantSelect.find('option:selected');
            var variantPrice = parseFloat(selectedVariant.data('cost'));
            var $quantityInput = $card.find('.quantity');
            var quantity = parseInt($quantityInput.val());
            var totalPrice;

            // Check if the product has variants
            if ($variantSelect.length) {
                totalPrice = variantPrice * quantity;
            } else {
                // If no variants, use the price from the price element
                var basePrice = parseFloat($card.find('.price').data('price'));
                totalPrice = basePrice * quantity;
            }

            // Update the price display for the product
            var $priceElement = $card.find('.price');
            $priceElement.text('Price: ' + totalPrice.toFixed(2));

            // Accumulate subtotal
            subtotal += totalPrice;
        });

        // Update the subtotal and total display
        $('#subtotal').text(subtotal.toFixed(2));
        $('#total').text(subtotal.toFixed(2)); // Assuming no additional charges, total is same as subtotal
    }

    // Event listener for changes in variant selection
    $(document).on('change', '.verients', function() {
        updatePriceAndTotal();
    });

    // Event listener for changes in quantity input
    $(document).on('input', '.quantity', function() {
        updatePriceAndTotal();
    });

    // Initial calculation on page load
    updatePriceAndTotal();
});
</script>



    </div>
    {% endblock %}
    
